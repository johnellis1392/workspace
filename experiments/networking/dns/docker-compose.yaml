version: '3.3'

# Adaptation of the dns tutorial at:
# https://techpolymath.com/2015/02/16/how-to-setup-a-dns-server-for-a-home-lab-on-ubuntu-14-04/
services:

  # Host container
  host1:
    build:
      context: ./
      dockerfile: ./host1/Dockerfile
    environment:
      PORT: 3000
    hostname: host1.homelab.local
    networks:
      dns_network:
        ipv4_address: 10.1.100.90


  # Base app configuration
  app_base:
    image: dns_app_base
    build:
      context: ./app
      dockerfile: ./Dockerfile
      args:
        src_dir: /usr/src/app
        config_dir: /usr/src/config
    environment:
      PORT: 0
      SERVER_NAME: ""


  # First dns child container
  ns1:
    image: dns_app_base
    environment:
      PORT: 3000
      SERVER_NAME: "NS1"
    depends_on:
      - app_base
    hostname: ns1.homelab.local
    networks:
      dns_network:
        ipv4_address: 10.1.100.41


  # Second dns child container
  ns2:
    image: dns_app_base
    environment:
      PORT: 3000
      SERVER_NAME: "NS2"
    depends_on:
      - app_base
    hostname: ns2.homelab.local
    networks:
      dns_network:
        ipv4_address: 10.1.100.42


networks:
  dns_network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.1.100.0/24
